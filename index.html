<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>StreamLab — Netflix Picker</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* -------------------- MOBILE-FIRST DESIGN -------------------- */
    :root{ --bg:#0a0a0a; --surface:#101010; --elev:#151515; --ink:#f5f5f5; --muted:#a1a1aa; --line:#242424; --accent:#22c55e; --chip:#191919 }
    :root[data-theme="light"]{ --bg:#ffffff; --surface:#f7f7f8; --elev:#ffffff; --ink:#0a0a0a; --muted:#52525b; --line:#e5e5e5; --accent:#0ea5e9; --chip:#ffffff }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:'Space Grotesk',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    /* Shell */
    .wrap{max-width:100%;margin:0 auto}
    header{position:sticky;top:0;z-index:30;background:rgba(10,10,10,.9);backdrop-filter:blur(8px) saturate(1.2);border-bottom:1px solid var(--line)}
    :root[data-theme="light"] header{background:rgba(255,255,255,.85)}

    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px calc(12px + env(safe-area-inset-top));gap:10px}
    .brand{display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:999px;background:#fff}
    .logo{margin:0;font-weight:800;letter-spacing:.18em;text-transform:uppercase;font-size:16px}
    .actions{display:flex;align-items:center;gap:8px}
    .btn{appearance:none;cursor:pointer;border:1px solid var(--line);background:var(--elev);color:var(--ink);border-radius:999px;padding:10px 14px;min-height:44px;font-size:16px;font-weight:700;letter-spacing:.02em}
    @media(hover:hover){.btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.35)}}
    .btn[aria-pressed="true"], .btn.accent{background:var(--accent);border-color:var(--accent);color:#0a0a0a}

    .hero{border-bottom:1px solid var(--line);padding:14px}
    .kicker{color:var(--muted);text-transform:uppercase;letter-spacing:.22em;font-size:11px}
    .h1{font-size:28px;line-height:1.15;font-weight:900;margin:8px 0 6px}
    .sub{color:#d4d4d8;font-size:14px}
    :root[data-theme="light"] .sub{color:#333}

    /* Controls: collapsible drawer on mobile */
    details.controls{background:var(--surface);border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
    details[open] .summary{border-bottom:1px solid var(--line)}
    .summary{list-style:none;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .summary h3{margin:0;font-size:14px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
    .summary .chev{font-size:18px}

    .panel{padding:12px 14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.16em;margin-bottom:6px}
    select,input[type=range]{appearance:none;background:var(--elev);color:var(--ink);border:1px solid var(--line);border-radius:14px;padding:12px 14px;font-size:16px;min-height:44px}
    @supports(-webkit-touch-callout:none){select,input{font-size:16px}}
    .seg{display:flex;gap:8px}
    .seg .btn{flex:1}

    /* Sticky action bar: Suggest + Load more (mobile-first) */
    .actionbar{position:sticky;bottom:0;z-index:25;background:linear-gradient(180deg,rgba(0,0,0,0),var(--bg) 30%);padding:8px 12px calc(8px + env(safe-area-inset-bottom));border-top:1px solid var(--line)}
    .actionbar .btn{width:100%}
    #btnLoadMore{margin-top:8px;display:none}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;padding:12px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:920px){.grid{grid-template-columns:repeat(5,minmax(0,1fr));max-width:1200px;margin:0 auto}}

    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .poster{aspect-ratio:2/3;background:#0b0b0b;position:relative}
    .poster img{width:100%;height:100%;object-fit:cover}
    .fav{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);border:1px solid var(--line);backdrop-filter:blur(4px);border-radius:999px;padding:6px 10px;font-size:12px;color:#fff}
    .fav[aria-pressed="true"]{background:var(--accent);color:#0a0a0a}
    .meta{padding:10px}
    .title{font-weight:800;font-size:15px;line-height:1.2}
    .chips{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .chip{border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700}
    .overview{margin-top:6px;font-size:13px;color:#e5e5e5;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
    .overview.expanded{display:block;-webkit-line-clamp:unset;overflow:visible}
    :root[data-theme="light"] .overview{color:#222}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .row .btn{flex:1 1 48%;min-width:48%}

    /* Spinner + errors */
    #results[data-loading="true"]::before{content:"";display:block;width:40px;height:40px;margin:14px auto;border:3px solid #2a2a2a;border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{margin:8px 12px;background:#7f1d1d;color:#fee2e2;padding:10px;border-radius:10px;text-align:center;font-size:14px}

    /* Floating theme switch */
    .fab-switch{position:fixed;z-index:60;right:calc(14px + env(safe-area-inset-right));bottom:calc(14px + env(safe-area-inset-bottom));padding:6px;border-radius:999px;backdrop-filter:blur(10px);background:rgba(0,0,0,.2)}
    .switch{position:relative;display:inline-block;width:56px;height:32px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#1f1f1f;border:1px solid var(--line);border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:24px;width:24px;left:4px;top:3px;background:#fff;border-radius:50%;transition:.2s}
    input:checked + .slider{background:var(--accent)}
    input:checked + .slider:before{transform:translateX(24px)}

    footer{border-top:1px solid var(--line);padding:14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="topbar">
        <div class="brand"><span class="dot"></span><h1 class="logo">StreamLab</h1></div>
        <div class="actions">
          <button id="btnFavs" class="btn">Favorites</button>
          <button id="btnRandom" class="btn">Random</button>
        </div>
      </div>
      <div class="hero">
        <div class="kicker">Netflix-focused • Region-aware</div>
        <div class="h1">Find your next Movie or Series</div>
        <p class="sub">Filter by type, region, genre, and rating. Save favorites, watch trailers, share picks, and load more as you scroll.</p>
      </div>
      <details class="controls">
        <summary class="summary"><h3>Filters</h3><span class="chev">▾</span></summary>
        <div class="panel">
          <div class="col">
            <label>Type</label>
            <div class="seg">
              <button id="btnMovie" class="btn" aria-pressed="true">Movie</button>
              <button id="btnTV" class="btn" aria-pressed="false">Series</button>
            </div>
          </div>
          <div class="col">
            <label>Region</label>
            <select id="regionSelect"></select>
          </div>
          <div class="col">
            <label>Genre</label>
            <select id="genreSelect"><option value="">Any</option></select>
          </div>
          <div class="col">
            <label>Min rating: <span id="ratingValue">6.5</span></label>
            <input type="range" id="minRating" min="0" max="9" step="0.5" value="6.5" />
          </div>
        </div>
      </details>
      <div class="actionbar">
        <button id="btnSuggest" class="btn accent">Suggest titles</button>
        <button id="btnLoadMore" class="btn">Load more</button>
      </div>
    </header>

    <section id="results" class="grid" aria-live="polite" aria-busy="false"></section>
    <div id="errorBox" class="error" style="display:none"></div>

    <footer>
      * Availability is inferred from TMDB watch providers per region. Data & posters © TMDB contributors. This product uses the TMDB API but is not endorsed or certified by TMDB.
    </footer>
  </div>

  <!-- Modal for trailers -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Trailer" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.75);padding:20px;z-index:50">
    <div class="modal-inner" style="background:var(--surface);border:1px solid var(--line);border-radius:16px;max-width:900px;width:100%;aspect-ratio:16/9;position:relative;overflow:hidden">
      <button class="modal-close" id="modalClose" style="position:absolute;top:8px;right:8px" class="btn">Close</button>
      <iframe id="ytFrame" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen style="width:100%;height:100%;border:0"></iframe>
    </div>
  </div>

  <!-- Floating Theme Toggle -->
  <div class="fab-switch" aria-label="Toggle theme">
    <label class="switch"><input id="themeToggle" type="checkbox"><span class="slider"></span></label>
  </div>

<script>
  // ===== Config =====
  var TMDB_KEY = "daa745e9c8be7937a25bed1106d9c723";
  var DEFAULT_REGION = "US";
  var IMG_BASE = "https://image.tmdb.org/t/p/w342";

  // ===== State =====
  var currentType = "movie";
  var cachedGenres = { movie: [], tv: [] };
  var cachedProviderIdByRegion = {};
  var lastResults = [];
  var favKey = 'sl_favs_v1';
  var favs = loadFavs();
  var discoverBase = '';
  var nextPage = 1;
  var totalPages = 1;

  // ===== DOM =====
  var regionSelect = document.getElementById('regionSelect');
  var genreSelect = document.getElementById('genreSelect');
  var ratingRange = document.getElementById('minRating');
  var ratingValue = document.getElementById('ratingValue');
  var resultsEl = document.getElementById('results');
  var btnMovie = document.getElementById('btnMovie');
  var btnTV = document.getElementById('btnTV');
  var btnSuggest = document.getElementById('btnSuggest');
  var btnRandom = document.getElementById('btnRandom');
  var btnFavs = document.getElementById('btnFavs');
  var themeToggle = document.getElementById('themeToggle');
  var btnLoadMore = document.getElementById('btnLoadMore');
  var errorBox = document.getElementById('errorBox');
  var modal = document.getElementById('modal');
  var modalClose = document.getElementById('modalClose');
  var ytFrame = document.getElementById('ytFrame');

  // ===== Init =====
  bootstrap();

  function bootstrap(){
    var storedTheme = localStorage.getItem('sl_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', storedTheme);
    themeToggle.checked = storedTheme === 'light';

    var regions = [
      { code:'US', name:'United States' },
      { code:'IN', name:'India' },
      { code:'GB', name:'United Kingdom' },
      { code:'CA', name:'Canada' },
      { code:'AU', name:'Australia' },
      { code:'SG', name:'Singapore' },
      { code:'AE', name:'UAE' }
    ];
    regions.forEach(function(r){ var o=document.createElement('option'); o.value=r.code; o.textContent=r.name+' ('+r.code+')'; regionSelect.appendChild(o) });
    regionSelect.value = DEFAULT_REGION;

    ratingRange.addEventListener('input', function(){ ratingValue.textContent = ratingRange.value; }, { passive:true });
    btnMovie.addEventListener('click', function(){ setType('movie'); });
    btnTV.addEventListener('click', function(){ setType('tv'); });
    btnSuggest.addEventListener('click', suggest);
    btnFavs.addEventListener('click', showFavs);
    btnLoadMore.addEventListener('click', loadMore);
    themeToggle.addEventListener('change', function(){ var t = themeToggle.checked ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', t); localStorage.setItem('sl_theme', t); });

    window.addEventListener('scroll', onScrollLoadMore, {passive:true});

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e){ if(e.target === modal){ closeModal(); } });

    loadGenres('movie');
  }

  function setType(t){ currentType = t; btnMovie.setAttribute('aria-pressed', t==='movie'); btnTV.setAttribute('aria-pressed', t==='tv'); loadGenres(t); }

  function loadGenres(t){
    genreSelect.innerHTML = '<option value="">Any</option>';
    if(!cachedGenres[t].length){
      var url = 'https://api.themoviedb.org/3/genre/' + t + '/list?api_key=' + TMDB_KEY + '&language=en-US';
      fetchJSON(url).then(function(data){
        cachedGenres[t] = data && data.genres ? data.genres : [];
        cachedGenres[t].forEach(function(g){ var opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; genreSelect.appendChild(opt); });
      }).catch(function(){ showError('Failed to load genres.'); });
    } else {
      cachedGenres[t].forEach(function(g){ var opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; genreSelect.appendChild(opt); });
    }
  }

  // Use type-aware providers endpoint (tv vs movie)
  function getNetflixProviderId(region){
    var key = region + ':' + currentType;
    if(cachedProviderIdByRegion[key]) return Promise.resolve(cachedProviderIdByRegion[key]);
    var url = 'https://api.themoviedb.org/3/watch/providers/' + (currentType==='tv'?'tv':'movie') + '?api_key=' + TMDB_KEY + '&watch_region=' + region;
    return fetchJSON(url).then(function(data){
      var res = (data && data.results) ? data.results : [];
      var nf = res.find(function(p){ return p.provider_name==='Netflix'; });
      var id = nf ? nf.provider_id : 8; // fallback
      cachedProviderIdByRegion[key] = id; return id;
    }).catch(function(){ return 8; });
  }

  function buildDiscoverBase(region, genreId, minRating){
    return 'https://api.themoviedb.org/3/discover/' + currentType + '?api_key=' + TMDB_KEY +
           '&watch_region=' + region + '&with_watch_providers=' + cachedProviderIdByRegion[region+':'+currentType] +
           '&with_watch_monetization_types=flatrate&include_adult=false&language=en-US' +
           '&sort_by=popularity.desc' + (genreId ? '&with_genres=' + genreId : '') +
           '&vote_average.gte=' + minRating;
  }

  function suggest(){
    var region = regionSelect.value || DEFAULT_REGION;
    var genreId = genreSelect.value;
    var minRating = Number(ratingRange.value);

    resultsEl.setAttribute('data-loading','true');
    resultsEl.setAttribute('aria-busy','true');
    resultsEl.innerHTML = '';
    hideError();

    getNetflixProviderId(region).then(function(){
      discoverBase = buildDiscoverBase(region, genreId, minRating);
      nextPage = 1; totalPages = 1; lastResults = [];
      loadMore();
    });
  }

  function loadMore(){
    if(nextPage>totalPages) return;
    fetchJSON(discoverBase + '&page=' + nextPage).then(function(data){
      totalPages = Math.min(10, (data && data.total_pages) ? data.total_pages : 1);
      var rs = data && data.results ? data.results : [];
      var filtered = rs.filter(function(item){ return item.poster_path && item.overview && item.vote_count>=50 });
      lastResults = lastResults.concat(filtered);
      appendCards(filtered);
      nextPage++;
      resultsEl.removeAttribute('data-loading');
      resultsEl.setAttribute('aria-busy','false');
      document.getElementById('btnLoadMore').style.display = (nextPage<=totalPages) ? 'block' : 'none';
    }).catch(function(){ showError('Fetch failed. Try again.'); resultsEl.removeAttribute('data-loading'); resultsEl.setAttribute('aria-busy','false'); });
  }

  function onScrollLoadMore(){
    if(nextPage>totalPages) return;
    var y = window.innerHeight + window.scrollY;
    if(y > document.body.offsetHeight - 500){ loadMore(); }
  }

  function appendCards(items){
    var frag = document.createDocumentFragment();
    items.forEach(function(it){ var div=document.createElement('div'); div.innerHTML = toCardHTML(it); var node=div.firstChild; bindCard(node,it); frag.appendChild(node); });
    resultsEl.appendChild(frag);
  }

  function toCardHTML(item){
    var name = currentType==='movie' ? (item.title||item.original_title) : (item.name||item.original_name);
    var year = (item.release_date||item.first_air_date||'').slice(0,4);
    var poster = item.poster_path ? (IMG_BASE + item.poster_path) : '';
    var rating = (item.vote_average||0).toFixed(1);
    var key = currentType+'-'+item.id;
    var isFav = !!favs[key];
    return (
      '<article class="card">\n' +
        '<div class="poster">' + (poster?('<img loading="lazy" alt="'+escapeHTML(name)+' poster" src="'+poster+'">'):'<span></span>') +
          '<button class="fav" data-key="'+key+'" aria-pressed="'+isFav+'">'+(isFav?'★ Saved':'☆ Save')+'</button>'+
        '</div>\n' +
        '<div class="meta">\n' +
          '<div class="title">'+escapeHTML(name)+'</div>\n' +
          '<div class="chips"><span class="chip">★ '+rating+'</span><span class="chip">'+(currentType==='movie'?'Movie':'Series')+(year?(' • '+year):'')+'</span></div>\n' +
          '<div class="overview">'+escapeHTML(item.overview)+'</div>\n' +
          '<button class="btn" data-action="more" style="margin-top:6px;width:100%">Read more</button>\n' +
          '<div class="row">\n' +
            '<a class="btn" data-action="trailer" data-id="'+item.id+'">Trailer</a>\n' +
            '<a class="btn" data-action="share" data-name="'+encodeURIComponent(name)+'">Share</a>\n' +
            '<a class="btn" href="https://www.netflix.com/search?q='+encodeURIComponent(name)+'" target="_blank" rel="noopener">Open</a>\n' +
          '</div>\n' +
        '</div>\n' +
      '</article>'
    );
  }

  function bindCard(cardEl, item){
    var favBtn = cardEl.querySelector('.fav');
    favBtn.addEventListener('click', function(){ var k=favBtn.getAttribute('data-key'); if(favs[k]){ delete favs[k]; favBtn.setAttribute('aria-pressed','false'); favBtn.textContent='☆ Save'; } else { favs[k]=item; favBtn.setAttribute('aria-pressed','true'); favBtn.textContent='★ Saved'; } localStorage.setItem(favKey, JSON.stringify(favs)); });

    cardEl.querySelector('[data-action="trailer"]').addEventListener('click', function(){ openTrailer(item.id); });
    cardEl.querySelector('[data-action="share"]').addEventListener('click', function(){ shareItem(item); });

    var moreBtn = cardEl.querySelector('[data-action="more"]');
    var overview = cardEl.querySelector('.overview');
    moreBtn.addEventListener('click', function(){ var exp=overview.classList.toggle('expanded'); moreBtn.textContent = exp ? 'Show less' : 'Read more'; });
  }

  function showFavs(){
    var keys = Object.keys(favs); if(!keys.length){ resultsEl.innerHTML='<p class="error" style="background:transparent;color:var(--muted)">No favorites yet. Tap ☆ Save on any title.</p>'; return; }
    var items = keys.map(function(k){ return favs[k]; }); lastResults = items.slice(); resultsEl.innerHTML=''; appendCards(items); document.getElementById('btnLoadMore').style.display='none';
  }

  function openTrailer(id){
    fetchJSON('https://api.themoviedb.org/3/'+currentType+'/'+id+'/videos?api_key='+TMDB_KEY+'&language=en-US').then(function(data){
      var vids = (data&&data.results)||[]; var yt = vids.find(function(v){return v.site==='YouTube' && (v.type==='Trailer' || v.type==='Teaser')});
      if(!yt){ showError('No trailer available.'); return; }
      ytFrame.src = 'https://www.youtube.com/embed/'+yt.key+'?autoplay=1&rel=0';
      modal.style.display='flex';
    }).catch(function(){ showError('Failed to load trailer.'); });
  }
  function closeModal(){ ytFrame.src=''; modal.style.display='none'; }

  function shareItem(item){
    var name = currentType==='movie' ? (item.title||item.original_title) : (item.name||item.original_name);
    var url='https://www.netflix.com/search?q='+encodeURIComponent(name);
    if(navigator.share){ navigator.share({title:name+' — StreamLab', text:'Found on StreamLab', url:url}).catch(function(){}); }
    else { copyText(url); alert('Share link copied!'); }
  }

  function fetchJSON(url){ return fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }); }
  function escapeHTML(s){ return String(s).replace(/[&<>"]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]); }); }
  function copyText(t){ var ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta); }
  function showError(msg){ errorBox.style.display='block'; errorBox.textContent=msg }
  function hideError(){ errorBox.style.display='none'; errorBox.textContent='' }
  function loadFavs(){ try{ return JSON.parse(localStorage.getItem(favKey)||'{}') }catch(e){ return {} } }
</script>
</body>
</html>
